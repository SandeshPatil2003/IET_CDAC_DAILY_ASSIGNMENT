package com.menucrud.dao;

import java.util.List;

import org.hibernate.query.Query;

import org.hibernate.Session;
import org.hibernate.SessionFactory;
import org.hibernate.Transaction;

import com.menucrud.beans.Book;

public class BookDaoImpl implements BookDao {

	private static SessionFactory sf=HibernateUtil.getMySessionFactory();

	@Override
	public boolean saveBook(Book b) {
		Session session = sf.getCurrentSession();
		
		Transaction tr = session.beginTransaction();
		
		
		session.save(b);
		tr.commit();
		
		return true;
	}

	@Override
	public boolean updateBookPrice(int bid, double newprice) {
		Session session = sf.getCurrentSession();
		Transaction tr = session.beginTransaction();
		
		Book b = session.get(Book.class,bid);
		b.setPrice(newprice);
	
		session.save(b);
		tr.commit();
		
		return true;
	}

//	@Override
//	public List<Book> getAllBooks() {
//		Session session = sf.getCurrentSession();
//		Transaction tr = session.beginTransaction();
//		
//		 String sql = "SELECT * FROM book101";
//		
//		Query<Book> query = session.createNativeQuery(sql, Book.class);
//		
//		List<Book> blist = query.list();
//		
//		
//		
//		tr.commit();
//		
//		return blist;
//		
//	}

	
	@Override
	public List<Book> getAllBooks() {
	    Session session = sf.getCurrentSession();
	    Transaction tr = session.beginTransaction();
	    
	    String hql = "FROM Book"; // Stick with HQL, it's cleaner
	    Query<Book> query = session.createQuery(hql, Book.class);
	    List<Book> blist = query.list();
	    
	    // --> FIX: Loop through the results to initialize the 'aset' (Authors set)
	    for (Book book : blist) {
	        // Accessing the collection forces Hibernate to load it now ("eagerly")
	        book.getAset().size(); 
	    }
	    // <-- End Fix

	    tr.commit(); // Session is closed here
	    
	    return blist; // Data is now fully loaded, even with the closed session
	}

	
}
